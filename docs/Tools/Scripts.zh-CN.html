<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>脚本 - The YSLib Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Book tranplanted from YSLib BitBucket wiki.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Home.html"><strong aria-hidden="true">1.</strong> 索引/Index</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Home.en-US.html"><strong aria-hidden="true">1.1.</strong> English Version</a></li><li class="chapter-item expanded "><a href="../Home.zh-CN.html"><strong aria-hidden="true">1.2.</strong> 简体中文版</a></li><li class="chapter-item expanded "><a href="../Contents.zh-CN.html"><strong aria-hidden="true">1.3.</strong> Contents(zh-CN)/主题目录</a></li></ol></li><li class="chapter-item expanded "><a href="../GettingStarted.zh-CN.html"><strong aria-hidden="true">2.</strong> 入门</a></li><li class="chapter-item expanded "><a href="../Development.zh-CN.html"><strong aria-hidden="true">3.</strong> 开发说明</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Prerequisitions.zh-CN.html"><strong aria-hidden="true">3.1.</strong> 先决条件</a></li><li class="chapter-item expanded "><a href="../GettingSources.zh-CN.html"><strong aria-hidden="true">3.2.</strong> 获取源代码</a></li><li class="chapter-item expanded "><a href="../Build.zh-CN.html"><strong aria-hidden="true">3.3.</strong> 构建</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../BuildDocumentation.zh-CN.html"><strong aria-hidden="true">3.3.1.</strong> 构建文档</a></li></ol></li><li class="chapter-item expanded "><a href="../Test.zh-CN.html"><strong aria-hidden="true">3.4.</strong> 测试</a></li><li class="chapter-item expanded "><a href="../Run.zh-CN.html"><strong aria-hidden="true">3.5.</strong> 运行</a></li></ol></li><li class="chapter-item expanded "><a href="../Features.zh-CN.html"><strong aria-hidden="true">4.</strong> 结构和特性</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ProjectDependencies.zh-CN.html"><strong aria-hidden="true">4.1.</strong> （内部）项目依赖性说明</a></li><li class="chapter-item expanded "><a href="../Features/NPL.zh-CN.html"><strong aria-hidden="true">4.2.</strong> NPL</a></li></ol></li><li class="chapter-item expanded "><a href="../EMPTY.html"><strong aria-hidden="true">5.</strong> 应用开发环境</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Sysroot.zh-CN.html"><strong aria-hidden="true">5.1.</strong> Sysroot</a></li><li class="chapter-item expanded "><a href="../YDE.zh-CN.html"><strong aria-hidden="true">5.2.</strong> YDE</a></li></ol></li><li class="chapter-item expanded "><a href="../EMPTY.html"><strong aria-hidden="true">6.</strong> 项目维护资源</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Releases.zh-CN.html"><strong aria-hidden="true">6.1.</strong> 发布工程</a></li><li class="chapter-item expanded "><a href="../Archives.zh-CN.html"><strong aria-hidden="true">6.2.</strong> 归档</a></li></ol></li><li class="chapter-item expanded "><a href="../EMPTY.html"><strong aria-hidden="true">7.</strong> 工具</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Tools/SHBuild.zh-CN.html"><strong aria-hidden="true">7.1.</strong> SHBuild</a></li><li class="chapter-item expanded "><a href="../Tools/RevisionPatcher.zh-CN.html"><strong aria-hidden="true">7.2.</strong> RevisionPatcher</a></li><li class="chapter-item expanded "><a href="../Tools/SXML2XML.zh-CN.html"><strong aria-hidden="true">7.3.</strong> SXML2XML</a></li><li class="chapter-item expanded "><a href="../Tools/ProjectGenerator.zh-CN.html"><strong aria-hidden="true">7.4.</strong> ProjectGenerator</a></li><li class="chapter-item expanded "><a href="../Tools/Scripts.zh-CN.html" class="active"><strong aria-hidden="true">7.5.</strong> 脚本</a></li></ol></li><li class="chapter-item expanded "><a href="../Tutorial.zh-CN.html"><strong aria-hidden="true">8.</strong> 教程</a></li><li class="chapter-item expanded "><a href="../EMPTY.html"><strong aria-hidden="true">9.</strong> 附录/Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Terminology.zh-CN.html"><strong aria-hidden="true">9.1.</strong> 术语概要</a></li><li class="chapter-item expanded "><a href="../StandardUsing.en-US.html"><strong aria-hidden="true">9.2.</strong> Standard Using</a></li><li class="chapter-item expanded "><a href="../ReportedIssues.en-US.html"><strong aria-hidden="true">9.3.</strong> Reported Issues</a></li><li class="chapter-item expanded "><a href="../WikiRules.en-US.html"><strong aria-hidden="true">9.4.</strong> Wiki Rules</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The YSLib Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#概述" id="概述">概述</a></h1>
<p>YSLib 项目提供一系列工具脚本。这些脚本主要集中位于 <code>Tools</code> 和 <code>Tools/Scripts</code> 。其余特定局部用途的脚本可能位于其它目录。</p>
<h1><a class="header" href="#解释环境" id="解释环境">解释环境</a></h1>
<p>脚本解释器要求宿主环境（符合 YSLib 源码 <code>YF_Hosted</code> 定义支持的平台，指具有操作系统的环境）。</p>
<p>除非另行指定，脚本以文件的形式部署。</p>
<h2><a class="header" href="#脚本文件" id="脚本文件">脚本文件</a></h2>
<p><strong>脚本总是使用以下约定的扩展名。</strong></p>
<p>除了 Windows 命令解释器使用的 <code>.cmd</code> 文件以及 NPLA1 脚本使用的 <code>.txt</code> 文件，所有脚本使用 <a href="http://zh.wikipedia.org/zh-cn/Shebang">Shebang</a> 明确需要使用的解释环境（详见 Shell 脚本的说明）。</p>
<p>Windows 命令解释器脚本因为实现限制使用本机 ANSI 代码页的编码，约定为兼容 ASCII 。</p>
<p>NPLA1 脚本约定使用带有 BOM 的 UTF-8 编码（去除 BOM 的脚本可能兼容 ASCII ）。详见 <a href="SHBuild.zh-CN.html">stage 1 SHBuild 中关于 NPL 支持的说明</a>。</p>
<h2><a class="header" href="#外部环境" id="外部环境">外部环境</a></h2>
<p>项目中提供的脚本在版本库中具有固定的相对路径。除解释环境适用的公共的约定（如提供一般类 UNIX 系统使用的文件系统布局的 <a href="https://zh.wikipedia.org/zh-cn/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84%E6%A0%87%E5%87%86">FHS（文件系统层次结构标准）</a>），脚本不预设绝对路径的假定。</p>
<p><strong>警告</strong> 小心处理路径。当前脚本直接或间接使用的所有涉及文件系统递归操作均不假设检查遍历的目标之间是否重复，若使用不恰当的目录链接，可能造成未预期的行为（如复制指向父目录的目录链接时可引起无限递归）。部署时应提前确保不存在这样的链接。</p>
<h1><a class="header" href="#接口约定" id="接口约定">接口约定</a></h1>
<p>脚本变量可能被读取和加载。除非另行指定，非导出的变量和名称以 <code>_</code> 结尾的变量，都不是公开接口。</p>
<h1><a class="header" href="#构建脚本" id="构建脚本">构建脚本</a></h1>
<p>一些脚本被用于构建。构建脚本的一般形式提供配置和生成阶段的自动化功能。</p>
<p>配置阶段设置交互环境（典型地，通过执行命令前设置的环境变量）。</p>
<p>生成阶段调用合适的工具完成构建。</p>
<p>配置阶段的接口可能对外隐藏，此时使用默认配置进行构建。</p>
<h2><a class="header" href="#shell-脚本" id="shell-脚本">Shell 脚本</a></h2>
<p>扩展名 <code>.sh</code> 的脚本是 shell 脚本，但其中大多数脚本需要使用 GNU bash 运行，如：</p>
<pre><code>#!/usr/bin/bash
</code></pre>
<p>需要考虑兼容性时，一般使用</p>
<pre><code>#!/usr/bin/env bash
</code></pre>
<p>代替。</p>
<p>其它可以直接兼容 POSIX shell 的 <code>.sh</code> 脚本使用 Shebang 如：</p>
<pre><code>#!/usr/bin/sh
</code></pre>
<p>需要考虑兼容性时，一般使用</p>
<pre><code>#!/usr/bin/env sh
</code></pre>
<p>代替。</p>
<p>为简化脚本代码，用户需要保证调用 shell 脚本时，环境应满足以下条件，否则行为未指定：</p>
<ul>
<li>变量 <code>IFS</code> 未设置或设置为默认值 <code>:</code> 。</li>
<li>同 <code>bash</code> 的 <code>-p</code> 选项启用时效果相同。
<ul>
<li>用户应保证不设置 <code>CDPATH</code> 等 <code>-p</code> 忽略的环境变量及 <code>$BASH_ENV</code> 等启动文件以避免未预期的不同行为。</li>
</ul>
</li>
<li>脚本文件不是目标在不同目录中的符号链接。
<ul>
<li>允许使用 <code>BASH_SOURCE[0]</code> 或 <code>${BASH_SOURCE%/*}</code> 等形式较可靠地判断脚本文件的路径。</li>
<li>部分脚本可能有更进一步的使用限制，可能直接使用 <code>&quot;$0&quot;</code> 判断路径。</li>
</ul>
</li>
<li>不使用和脚本中函数名冲突的别名。（在 bash 中，这默认不需要关注，需使用 <code>shopt -s expand_aliases</code> 显式启用引起冲突的功能。）</li>
</ul>
<p>脚本实现中的调用不受以上限制。</p>
<p>若脚本可以确保兼容 POSIX shell ，使用后者而不是前者。</p>
<p>如果对应解释器位于其它目录，可以符号链接到上面指定的路径。</p>
<p>除非另行指定，本文档约定使用的路径字符串的分隔符为 <code>/</code> ，不连续出现在路径中，且不在结尾出现。例外：</p>
<ul>
<li>平台相关的绝对路径转义可出现 <code>//</code> 。</li>
<li>构成路径的路径前缀可能以分隔符结尾，直接表示上层目录。</li>
</ul>
<p><strong>注意</strong> 在一些环境中可能因为可执行权限问题导致无法立即执行脚本，参见<a href="../GettingSources.zh-CN.html">这里的说明</a> 。</p>
<h2><a class="header" href="#shell-语言使用规约" id="shell-语言使用规约">Shell 语言使用规约</a></h2>
<p>除非另行指定，已定义的 shell 函数假定不被其它变量覆盖。（这允许实现省略 <code>readonly -f</code> 或 <code>declare -g -r -f</code> 声明，且允许使用相同的定义覆盖以简化调试。）</p>
<p>除非另行指定，返回非数值的 shell 函数使用 <code>echo</code> 输出返回的值。</p>
<p>非生成的代码中不使用包含 <code>__</code> 的名称。</p>
<p>公开函数的函数名及公开的变量名不以 <code>_</code> 结尾，否则以一个 <code>_</code> 结尾。</p>
<p>对 SHBuild 相关工具使用的函数，使用前缀 <code>SHBuild</code> 。</p>
<h2><a class="header" href="#npla1-脚本" id="npla1-脚本">NPLA1 脚本</a></h2>
<p><a href="../Features/NPL.zh-CN.html">NPL</a> 脚本可被 <a href="SHBuild.zh-CN.html">stage 1 SHBuild</a> 调用。</p>
<p>针对 <a href="../Sysroot.zh-CN.html">Sysroot</a> 构建的需求，当前支持 NPLA1 限于特定实现初始化例程支持。</p>
<p>在 shell 脚本中，NPL 代码以字符串的形式存储。</p>
<p>NPLA1 脚本可提供部分 shell 脚本中的同名函数。除非另行指定，这些函数的调用接口以及功能和 shell 脚本中的同名函数一致，但实现和以下行为不保证相同：</p>
<ul>
<li>缓存的变量及相关的输出提示信息；</li>
<li>性能；</li>
<li>影响的非公开环境变量等其它外部环境状态。</li>
</ul>
<h1><a class="header" href="#tools" id="tools">Tools</a></h1>
<p>未归类的工具目录。这个目录的脚本可以用于整个项目或项目的一部分。</p>
<h2><a class="header" href="#toolsinstall-sysrootsh" id="toolsinstall-sysrootsh">Tools/install-sysroot.sh</a></h2>
<p><a href="../Sysroot.zh-CN.html">Sysroot</a> 安装脚本。用于直接构建和部署基础环境。</p>
<p>构建时会调用 <code>Tools/Scripts</code> 目录下的脚本，按需构建 <a href="SHBuild.zh-CN.html">stage 1 SHBuild</a> 后间接调用 <code>SHBuild</code> 构建 <code>YBase</code> 和 <code>YFramework</code> 的静态库和动态库，再构建依赖于动态库的 <code>SHBuild</code> 。</p>
<p>当前所有部署都指定到 YSLib 版本库根目录下的 <code>build/$SHBuild_Host_Platform</code> 目录，其中 $SHBuild_Host_Platform 是宿主平台目录名，调用 <code>SHBuild-common.sh</code> 中的函数 <code>SHBuild_CheckHostPlatform</code> 后。 </p>
<p>部署时使用 stage 1 SHBuild 更新文件和目录，在必要时创建符号链接或硬链接，若失败则改为普通复制。仅当被部署的文件为中间目标启用硬链接，以免后续操作意外覆盖源文件。注意在 Windows 上创建符号链接可能因为权限不足失败，取决于用户和组策略。建议使用系统管理权限运行以避免可能的权限问题。</p>
<h3><a class="header" href="#基本使用方式" id="基本使用方式">基本使用方式</a></h3>
<p>脚本中使用以下配置传递至 <code>SHBuild</code> ：</p>
<pre><code>: ${SHBuild_BuildOpt:=&quot;-xj,6&quot;}
: ${SHBuild_LogOpt:=&quot;-xlogfl,128&quot;}
: ${SHBuild_Opt:=&quot;${SHBuild_LogOpt} ${SHBuild_BuildOpt}&quot;}
</code></pre>
<p>因此可以直接用 <code>export</code> 或直接在命令行指定变量覆盖默认行为，如</p>
<pre><code>SHBuild_BuildOpt=-xj,2 Tools/install-sysroot.sh
</code></pre>
<p>使用 2 个并行线程构建。</p>
<p>脚本也支持变量配置构建使用的路径：</p>
<pre><code>: ${SHBuild_SysRoot=&quot;$YSLib_BaseDir/sysroot&quot;}
: ${SHBuild_BuildDir:=&quot;$YSLib_BaseDir/build/$SHBuild_Host_Platform&quot;}
</code></pre>
<p>其中：</p>
<ul>
<li>变量 <code>SHBuild_SysRoot</code> 指定输出的 SysRoot 根路径。
<ul>
<li>默认值为 <code>$YSLib_BaseDir</code> 下的 <code>sysroot</code> 。</li>
</ul>
</li>
<li>变量 <code>SHBuild_BuildDir</code> 指定构建使用的中间输出文件路径。
<ul>
<li>默认值为 <code>$YSLib_BaseDir</code> 下的 <code>build</code> 目录下的 <code>$SHBuild_Host_Platform</code> 子目录。</li>
</ul>
</li>
<li>变量 <code>YSLib_BaseDir</code> 是 YSLib 目录，由脚本根据版本库所在目录确定。</li>
<li>变量 <code>SHBuild_Host_Platform</code> 是宿主平台前缀，由脚本 <code>Tools/Scripts/SHBuild-common.sh</code> 中的函数 <code>SHBuild_Platform_Detect</code> 确定。</li>
<li>变量 <code>SHBuild_SystemPrefix</code> 是系统前缀，在 SysRoot 根路径下决定安装路径，由脚本 <code>Tools/Scripts/SHBuild-common.sh</code> 中的函数 <code>SHBuild_GetSystemPrefix</code> 确定。</li>
</ul>
<p>在 stage 1 SHBuild 构建调用 NPLA1 脚本 <code>Tools/Scripts/SHBuild-YSLib*.txt</code> ，调用方式和接受的配置（构建目标等）、具体默认设置和注意事项见对应 shell 脚本的文档相关章节。</p>
<h1><a class="header" href="#toolsscripts" id="toolsscripts">Tools/Scripts</a></h1>
<p>这个目录的脚本可用于整个项目或项目核心部分的构建工具使用。</p>
<p>当前有以下脚本忽略重复的 <code>.</code> 或 <code>source</code> 命令：</p>
<ul>
<li>SHBuild-common.sh</li>
</ul>
<p>以前缀 <code>SHBuild_</code> 起始的名称保留使用。其中前缀 <code>SHBuild_Env_</code> 总是表示环境配置的只读变量名。</p>
<h2><a class="header" href="#toolsscriptsgenerateprojectssh" id="toolsscriptsgenerateprojectssh">Tools/Scripts/GenerateProjects.sh</a></h2>
<p>调用 <a href="ProjectGenerator.zh-CN.html">ProjectGenerator</a> 生成项目文件。</p>
<p>当前支持生成所有 <code>.cbp</code> 文件。</p>
<p>要求可使用 <code>hg</code> 或 <code>git</code> 命令取版本库根目录，否则不保证输出到正确的路径。</p>
<h3><a class="header" href="#变量-projectgenerator" id="变量-projectgenerator">变量 ProjectGenerator</a></h3>
<p>调用 RevisionPatcher 的命令。默认直接使用 <code>which ProjectGenerator</code> 的结果，一般要求可执行文件在环境变量 <code>PATH</code> 中。</p>
<h2><a class="header" href="#toolsscriptspatchrevisionsh" id="toolsscriptspatchrevisionsh">Tools/Scripts/PatchRevision.sh</a></h2>
<p>开发过程中使用 <a href="RevisionPatcher.zh-CN.html">RevisionPatcher</a> 维护源文件中版本号的脚本。</p>
<p>当前只支持 Mercurial 版本库的已添加或修改的未提交文件。</p>
<p>脚本首先把未提交的这些修改导出为补丁备份到版本库根目录的 <code>bak.patch</code> ，然后使用这些内容调用 RevisionPatcher 取得文件和对应的新的版本号列表，最后使用 <code>sed</code> 查找对应文件并更新版本号。</p>
<p>若没有找到 <code>\version r</code> 模式的版本号前缀则忽略写入版本号。写入的版本号不影响换行符。</p>
<h3><a class="header" href="#变量-patchbegin" id="变量-patchbegin">变量 PatchBegin</a></h3>
<p>匹配版本号的起始行，应为一个表示行数的正整数。默认值为 <code>&quot;1&quot;</code> 。</p>
<h3><a class="header" href="#变量-patchbegin-1" id="变量-patchbegin-1">变量 PatchBegin</a></h3>
<p>匹配版本号的结束行，应为一个表示行数的正整数。默认值为 <code>&quot;20&quot;</code> 。</p>
<h3><a class="header" href="#变量-revisionpatcher" id="变量-revisionpatcher">变量 RevisionPatcher</a></h3>
<p>调用 RevisionPatcher 的命令。默认直接使用 <code>which RevisionPatcher</code> 的结果，一般要求可执行文件在环境变量 <code>PATH</code> 中。</p>
<h2><a class="header" href="#toolsscriptsshbuild-bootstrapsh" id="toolsscriptsshbuild-bootstrapsh">Tools/Scripts/SHBuild-bootstrap.sh</a></h2>
<p>编译 <a href="SHBuild.zh-CN.html">stage 1 SHBuild</a> 时被包含的脚本。</p>
<p>其中指定了静态链接需要依赖的 YSLib 源文件以及头文件路径等。</p>
<h2><a class="header" href="#toolsscriptsshbuild-buildsh" id="toolsscriptsshbuild-buildsh">Tools/Scripts/SHBuild-build.sh</a></h2>
<p>编译 <a href="SHBuild.zh-CN.html">stage 1 SHBuild</a> 的脚本。</p>
<p>使用变量 <code>SHBuild_Output</code> 指定输出路径。默认值为 <code>SHBuild</code> ，即在当前工作目录下生成名为 <code>SHBuild</code> 的可执行文件（视宿主平台不同可能带后缀如 Win32 带 <code>.exe</code> ）。</p>
<p>调用函数 <code>SHBuild_CheckPCH</code> 检查预编译头：若变量 SHBuild_NoPCH 非空则跳过预编译头，否则使用预编译头包含标准库头。预编译的头文件目标由 YBase 下的 <code>stdinc.h</code> ，之后构建时包含预编译头路径为 <code>$SHBuild_PCH_stdinc_h</code> 。后者的默认路径为当前工作目录下的 <code>stdinc.h</code> 。</p>
<p><strong>已知缺陷</strong> 不自动更新预编译头。</p>
<h2><a class="header" href="#toolsscriptsshbuild-buildappsh" id="toolsscriptsshbuild-buildappsh">Tools/Scripts/SHBuild-BuildApp.sh</a></h2>
<p>应用程序构建脚本。可利用此工具脚本构建特定_配置_ 下使用 YSLib 库和基础环境开发的应用程序。</p>
<p>当前只支持构建，不支持部署。</p>
<p>构建时调用的工具链命令行使用 <code>Tools/Scripts/SHBuild-common-options.sh</code> 和 <code>Tools/Scripts/SHBuild-common-toolchain.sh</code> 中的选项，详见以下相关章节。</p>
<p><strong>这个脚本是公开的工具</strong>，被 <code>Tools/install-sysroot.sh</code> 部署到安装路径下的 <code>bin</code> 目录下。</p>
<h3><a class="header" href="#基本原理" id="基本原理">基本原理</a></h3>
<p><strong>配置</strong> 是特定用途的一组程序输出的集合。常见软件配置可以区分目标平台，是否为调试配置等。</p>
<p>脚本通过设置特定的环境变量并调用 <a href="SHBuild.zh-CN.html"><code>SHBuild</code></a> 递归扫描指定目录完成构建。其中调用命令由变量 <code>SHBuild</code> 指定，默认值为 <code>SHBuild</code> 。</p>
<p>脚本支持区分 debug 和非 debug 配置以及静态和 DLL 配置。详见以下说明。</p>
<p>debug 配置总称 debug 模式。非 debug 配置总称 release 模式。</p>
<h3><a class="header" href="#使用须知" id="使用须知">使用须知</a></h3>
<ul>
<li>使用 <code>--help</code> 作为第一个参数调用此工具脚本查看选项和说明。</li>
<li>可以添加基础环境到 <code>PATH</code> 环境变量以简化脚本路径。</li>
<li>需要先准备源代码。<strong>注意</strong>源代码目录会被递归扫描，建议在目录中只包含所有需要构建的源文件或被包含的文件。</li>
</ul>
<h3><a class="header" href="#操作说明" id="操作说明">操作说明</a></h3>
<p>一般步骤：</p>
<ul>
<li>新建一个 GNU bash 脚本（以下称为_用户构建脚本_ ），通过 <code>source</code> 或 <code>.</code> 包含此脚本（若无法在 <code>PATH</code> 找到，需要使用完整路径）</li>
<li>以源代码所在目录的路径作为参数，执行通过此脚本包含的 <code>SHBuild_BuildApp</code> 函数，等待构建完成</li>
<li>直接包含后的脚本仍可使用 <code>--help</code> 作为第一个参数调用用户构建脚本查看选项和说明</li>
</ul>
<p>简化操作：也可以不创建用户构建脚本，直接在命令行中执行，例子见<a href="../GettingStarted.zh-CN.html">入门</a>。</p>
<p>若有必要，在<strong>source 行之前</strong>设置 <code>SHBuild_AppBaseDir</code> 变量为指定输出文件所在的目录的<strong>完整路径</strong> ，如</p>
<pre><code>SHBuild_AppBaseDir=&quot;`dirname &quot;$0&quot;`/../build&quot;`
</code></pre>
<p>指定相对于用户构建脚本上一层目录的 <code>build</code> 子目录下作为基准输出路径。若不显式设置此变量，工具脚本会指定其默认值为用户构建脚本所在的目录。</p>
<p>调用函数 <code>SHBuild_BuildApp</code> 。函数会自动加入必要的参数调用 SHBuild ，传递的参数依次具体如下：</p>
<ul>
<li>中间变量 <code>SHBOPT</code> 的值，包括根据配置决定的目录设置选项、 <code>-xid,include -xmode,2</code> 以及用户在脚本命令行指定的剩余选项 <code>SHBOPT_BASE</code></li>
<li>传递给函数的参数</li>
<li><code>SHBuild_BuildApp</code> 的值，用于编译器的库配置（包含路径以及使用 DLL 需要的宏定义 <code>-DYF_DLL -DYB_DLL</code> ），由脚本根据静态或动态库配置自动确定，无需重复输入类似选项</li>
</ul>
<p>特别注意，此函数执行<strong>以输出基准路径作为当前工作目录</strong>，需要以此为基准指定源文件路径（ <code>SHBuild</code> 使用的 <code>SRCPATH</code> 参数）。</p>
<p>通过脚本命令行间接传递给 <code>SHBuild</code> 的参数 <code>SHBOPT_BASE</code> 以及函数 <code>SHBuild_BuildApp</code> 的参数都可以进一步对构建过程进行调整，如 <code>-xj,2</code> 指定 2 个并行线程构建。</p>
<h3><a class="header" href="#配置设置" id="配置设置">配置设置</a></h3>
<p>用户构建脚本的第一个参数为 <code>-c名称</code> 的形式时，指定名称为<strong>配置名</strong>。传递给 SHBuild 指定使用 <code>.配置名</code> 相对路径（无需另外指定 <code>-xd,</code> 参数）。如 <code>-cdebug</code> 指定输出路径为 <code>.debug</code> 。省略此项默认配置名为 <code>shbuild</code> 。</p>
<p>脚本根据以下规则自动检测配置：</p>
<ul>
<li>若配置名以 <code>debug</code> 起始则视为 debug 配置，设置 <code>SHBuild_Debug</code> 为配置名。</li>
<li>若配置名以 <code>static</code> 结束则视为 static 配置，设置 <code>SHBuild_Static</code> 为配置名。</li>
</ul>
<h3><a class="header" href="#环境变量" id="环境变量">环境变量</a></h3>
<p>脚本根据变量 <code>SHBuild_Debug</code> 和 <code>SHBuild_Static</code> 是否为空确定具体配置。</p>
<p>默认情况下， release 配置会在链接器命令行加入 <code>-mwindows</code> ，<a href="../Prerequisitions.zh-CN.html">和 debug 配置编译的程序行为不保证相同</a>。设置非空变量 <code>SHBuild_NoAdjustSubsystem</code> 禁用此行为。</p>
<p>脚本已经导出了用于链接器的包含 YSLib 库命令行参数的变量 <code>LIBS</code> 。若有必要，可以重新赋值。</p>
<p>脚本导出变量 <code>SHBuild_CFLAGS</code> 和 <code>SHBuild_CXXFLAGS</code> 传递给 SHBuild 。</p>
<h2><a class="header" href="#toolsscriptsshbuild-commonsh" id="toolsscriptsshbuild-commonsh">Tools/Scripts/SHBuild-common.sh</a></h2>
<p>被应用程序构建脚本包含的脚本，提供公共基础功能。</p>
<p><strong>这个脚本是公开的工具</strong>，被 <code>Tools/install-sysroot.sh</code> 部署到安装路径下的 <code>bin</code> 目录下。</p>
<h3><a class="header" href="#函数-shbuild_put" id="函数-shbuild_put">函数 SHBuild_Put</a></h3>
<p>使用 <code>printf</code> 输出非格式字符串。</p>
<h3><a class="header" href="#函数-shbuild_puts" id="函数-shbuild_puts">函数 SHBuild_Puts</a></h3>
<p>使用 <code>printf</code> 输出非格式的换行的字符串。</p>
<p>换行符由变量 <code>SHBuild_EOL</code> 指定。当前默认值通过检查 <code>$COMSPEC</code> 是否定义，以确保 Windows 环境（包括 MSYS ）使用 CR+LF ，其它情况使用 LF 。</p>
<p><strong>注意</strong> 具体的检查逻辑实现可能在以后改变。</p>
<h3><a class="header" href="#函数-shbuild_assertnonempty" id="函数-shbuild_assertnonempty">函数 SHBuild_AssertNonempty</a></h3>
<p>断言第一参数为名称的变量非空，否则显示出错并退出。</p>
<p>使用 <code>eval</code> 实现。</p>
<h3><a class="header" href="#函数-shbuild_checkedcall" id="函数-shbuild_checkedcall">函数 SHBuild_CheckedCall</a></h3>
<p>断言第一参数为名称的变量非空，若空则使用 <code>eval</code> 对后续求值并初始化第一参数指定的只读变量。若发生初始化则在标准输出中显示。</p>
<h3><a class="header" href="#函数-shbuild_initreadonly" id="函数-shbuild_initreadonly">函数 SHBuild_InitReadonly</a></h3>
<p>检查第一参数为名称的命令存在，否则显示出错并退出。</p>
<p>使用 <code>hash</code> 实现以优化性能。</p>
<h3><a class="header" href="#函数-shbuild_checkuname" id="函数-shbuild_checkuname">函数 SHBuild_CheckUName</a></h3>
<p>调用 <code>SHBuild_CheckedCall</code> 初始化只读变量 <code>SHBuild_Env_OS</code> 和 <code>SHBuild_Env_Arch</code> 的值。</p>
<p>变量 <code>SHBuild_Env_OS</code> 的值标识操作系统：</p>
<ul>
<li><code>unkonwn</code> ： 不支持的系统</li>
<li><code>OS_X</code> ： <code>uname</code> 结果匹配 *Darwin* ，用于标识 OS X 系统</li>
<li><code>Win32</code> ： <code>uname</code> 结果匹配 *MIGW* 或 *MSYS* ，用于标识 Windows （桌面）系统</li>
<li><code>Linux</code> ： <code>uname</code> 结果匹配 *Linux* ，用于标识 Linux 系统</li>
</ul>
<p>变量 <code>SHBuild_Env_Arch</code> 的值标识体系结构：</p>
<ul>
<li><code>unknown</code> ： 不支持的体系结构</li>
<li>其它值：当前支持的体系结构 <code>uname -m</code> 的结果，主要包括 i686 和 x86_64</li>
</ul>
<p>若同时指定环境变量 <code>SHBuild_Env_Arch</code> 和 <code>SHBuild_Env_OS</code> ，不进行<a href="Prerequisitions.zh-CN.html">自动环境检测</a>，不依赖 <code>uname</code> 。</p>
<h3><a class="header" href="#函数-shbuild_2u" id="函数-shbuild_2u">函数 SHBuild_2u</a></h3>
<p>接受 1 个表示路径的参数。</p>
<p>调用 <code>cygpath</code> 转换 Windows 路径到 UNIX 路径。</p>
<p>当 <code>cygpath</code> 不存在时返回原路径。</p>
<h3><a class="header" href="#函数-shbuild_2w" id="函数-shbuild_2w">函数 SHBuild_2w</a></h3>
<p>接受 1 个表示路径的参数，调用 <code>cygpath</code> 转换 UNIX 路径到 Windows 路径。</p>
<p>当 <code>cygpath</code> 不存在时返回原路径。</p>
<h3><a class="header" href="#函数-shbuild_install" id="函数-shbuild_install">函数 SHBuild_Install</a></h3>
<p>接受 2 个表示路径的参数，安装前者指定的文件到后者。</p>
<p>首先调用 <code>rsync</code> ，若失败调用 <code>cp</code> 。</p>
<p><strong>注意</strong> 防火墙可能导致 <code>rsync</code> 超时失败。</p>
<h3><a class="header" href="#函数-shbuild_installdir" id="函数-shbuild_installdir">函数 SHBuild_InstallDir</a></h3>
<p>接受 2 个表示路径的参数，安装前者指定的目录到后者。</p>
<p>首先调用 <code>rsync</code> ，若失败调用 <code>cp</code> 。</p>
<p><strong>注意</strong> 防火墙可能导致 <code>rsync</code> 超时失败。</p>
<h3><a class="header" href="#函数-shbuild_install_exe" id="函数-shbuild_install_exe">函数 SHBuild_Install_Exe</a></h3>
<p>接受 2 个表示路径的参数，安装前者指定的可执行文件到后者。</p>
<p>首先调用 <code>SHBuild_Install</code> ，然后在目标上设置可执行权限。</p>
<h3><a class="header" href="#函数-shbuild_install_hardlink" id="函数-shbuild_install_hardlink">函数 SHBuild_Install_HardLink</a></h3>
<p>接受 2 个表示路径的参数，安装前者指定的文件到后者为硬链接。</p>
<p>首先删除目标，其次调用 Windows 命令解释器的 <code>mklink</code> ，若失败调用 <code>ln</code> 。</p>
<h3><a class="header" href="#函数-shbuild_install_hardlink_exe" id="函数-shbuild_install_hardlink_exe">函数 SHBuild_Install_HardLink_Exe</a></h3>
<p>接受 2 个表示路径的参数，安装前者指定的可执行文件到后者为硬链接。</p>
<p>首先调用 <code>SHBuild_Install_HardLink</code> ，然后在目标上设置可执行权限。</p>
<p><strong>注意</strong> <code>mklink</code> 需要 Windows Vista 后的命令解释器(<code>cmd</code>) 的支持。硬链接需要文件系统（如 NTFS ）支持。</p>
<h3><a class="header" href="#函数-shbuild_install_link" id="函数-shbuild_install_link">函数 SHBuild_Install_Link</a></h3>
<p>接受 2 个表示路径的参数，安装前者指定的可执行文件到后者为符号链接。</p>
<p>首先删除目标，其次调用 Windows 命令解释器的 <code>mklink</code> ，若失败调用 <code>ln</code> 。</p>
<p><strong>注意</strong> <code>mklink</code> 需要 Windows Vista 后的命令解释器(<code>cmd</code>) 的支持。符号链接需要文件系统（如 NTFS ）支持。权限不足可能导致 <code>mklink</code> 创建符号链接失败，可在组策略改变相关默认行为。在一些版本的系统上，可能需要<a href="https://support.microsoft.com/en-us/kb/2856739/en-us">进一步的配置</a>以通过链接执行文件。</p>
<h3><a class="header" href="#函数-shbuild_pushd" id="函数-shbuild_pushd">函数 SHBuild_Pushd</a></h3>
<p>同 <code>bash</code> 内建 <code>pushd</code> 但不回显标准输出。</p>
<h3><a class="header" href="#函数-shbuild_popd" id="函数-shbuild_popd">函数 SHBuild_Popd</a></h3>
<p>同 <code>bash</code> 内建 <code>popd</code> 但不回显标准输出。</p>
<h3><a class="header" href="#函数-shbuild_echoescape" id="函数-shbuild_echoescape">函数 SHBuild_EchoEscape</a></h3>
<p>当标准输出使用终端时调用 <code>echo -ne</code> 输出参数指定的 ANSI 转义序列。</p>
<p><strong>已知缺陷</strong> 不检查 <code>$TERM</code> 支持。</p>
<h3><a class="header" href="#函数-shbuild_echovar" id="函数-shbuild_echovar">函数 SHBuild_EchoVar</a></h3>
<p>接受 2 个参数 x 和 y ，以特定颜色显示为 x = y 的形式。</p>
<h3><a class="header" href="#函数-shbuild_echovar_n" id="函数-shbuild_echovar_n">函数 SHBuild_EchoVar_N</a></h3>
<p>接受 1 个参数 x ，调用 <code>SHBuild_EchoVar</code> 显示为 x = $x 的形式。</p>
<p>右侧求值时会替换参数中的 <code>.</code> 为 <code>_</code> 。</p>
<h3><a class="header" href="#函数-shbuild_buildgch" id="函数-shbuild_buildgch">函数 SHBuild_BuildGCH</a></h3>
<p>接受第一个参数指定的路径的头文件安装到第二个参数指定的路径下并使用第三个参数指定的命令行构建 GNU 预编译头。</p>
<h3><a class="header" href="#函数-shbuild_platform_detect" id="函数-shbuild_platform_detect">函数 SHBuild_Platform_Detect</a></h3>
<p>通过参数指定的操作系统和体系结构名，并结合环境变量，确定平台名称，检查非空并返回。</p>
<p>当前支持的结果包括：</p>
<ul>
<li>MinGW64</li>
<li>MinGW32</li>
<li>第一个参数指定的操作系统名</li>
</ul>
<p>当前 <code>Win32</code> 系统外的结果和 <code>SHBuild_CheckUName</code> 结果一致。否则，处理如下：</p>
<ul>
<li>若环境变量 <code>MSYSTEM</code> 设置为 <code>MINGW64</code> 或 <code>MINGW32</code> ，结果对应为 <code>MinGW64</code> 或 <code>MinGW32</code> 。</li>
<li>否则，若操作系统名为 <code>Win32</code> ：
<ul>
<li>若体系结构为 <code>x86_64</code> ，则结果为 <code>MinGW64</code> 。</li>
<li>否则，结果为 <code>MinGW32</code> 。</li>
</ul>
</li>
<li>否则，结果为操作系统名。</li>
</ul>
<h3><a class="header" href="#函数-shbuild_getsystemprefix" id="函数-shbuild_getsystemprefix">函数 SHBuild_GetSystemPrefix</a></h3>
<p>按参数指定的平台名称字符串返回系统前缀字符串。</p>
<p>系统前缀用于在文件系统中安装部署。</p>
<p>当前支持的结果包括：</p>
<ul>
<li>参数为 <code>MinGW64</code> 时，结果为 <code>/mingw64</code> ；</li>
<li>参数为 <code>MinGW32</code> 时，结果为 <code>/mingw32</code> ；</li>
<li>否则，结果为 <code>/usr</code> 。</li>
</ul>
<p>另见 <a href="../Sysroot.zh-CN.html">Sysroot</a> 。</p>
<h3><a class="header" href="#函数-shbuild_checkhostplatform" id="函数-shbuild_checkhostplatform">函数 SHBuild_CheckHostPlatform</a></h3>
<p>调用 <code>SHBuild_CheckUName</code> ，初始化变量 <code>SHBuild_Host_Platform</code> 的值。</p>
<p>初始化的值为宿主平台的名称，用于初始化构成路径等。</p>
<p>当前 <code>Win32</code> 系统外的结果和 <code>SHBuild_CheckUName</code> 结果一致。</p>
<h3><a class="header" href="#函数-shbuild_checkpch" id="函数-shbuild_checkpch">函数 SHBuild_CheckPCH</a></h3>
<p>检查是否设置了非空的 <code>SHBuild_NoPCH</code> ，否则调用 <code>SHBuild_BuildGCH</code> 并生成 GNU 风格预编译头文件并设置内部变量 <code>SHBuild_IncPCH</code> 为合适的命令行选项用于包含生成的预编译头文件。</p>
<p>支持两个参数，同 <code>SHBuild_BuildGCH</code> 的前两个参数。</p>
<h2><a class="header" href="#toolsscriptsshbuild-common-optionssh" id="toolsscriptsshbuild-common-optionssh">Tools/Scripts/SHBuild-common-options.sh</a></h2>
<p>被应用程序构建脚本包含的基础功能，提供默认的编译器和链接器命令行选项。</p>
<p>若某个变量提供默认值且执行脚本时没有非空值，则设置为脚本提供的默认值。</p>
<p><strong>这个脚本是公开的工具</strong>，被 <code>Tools/install-sysroot.sh</code> 部署到安装路径下的 <code>bin</code> 目录下。</p>
<p>支持 GCC/G++ 和 Clang/Clang++ 。</p>
<p>支持 ar 及与其兼容的工具。</p>
<p>变量 <code>CXX</code> 指定 C++ 编译器。</p>
<p><strong>注意</strong> G++ 和 Clang++ 不完全兼容。以下部分变量通过预先检查 <code>CXX</code> 程序名称判断 G++ 和 Clang ，并自动使用不同的选项默认值。因此直接通过符号链接等方式伪装会失效而导致错误。</p>
<p>通过判断 <code>uname</code> 是否包括 <code>MINGW</code> 或 <code>MSYS</code> 指定是否为 Win32 平台。</p>
<p>以下所有变量仅在空（包括未设置）时提供默认值，按顺序被指定。可在外部设置为非空值以避免被本脚本中的值覆盖。以下仅列出部分相对不容易变动的默认值，其它默认值参见脚本源代码。若不需要默认值，可以提前设置非空值或在 <code>.</code> 指令后直接设置其它（可能为空的）值。</p>
<h3><a class="header" href="#变量-c_cxxflags_gc" id="变量-c_cxxflags_gc">变量 C_CXXFLAGS_GC</a></h3>
<p>C/C++ 编译器生成二进制节 GC 选项，默认值为 <code>-fdata-sections -ffunction-sections</code> 。</p>
<p>设置后会被检查是否支持，参见下文。</p>
<h3><a class="header" href="#变量-ldflags_gc" id="变量-ldflags_gc">变量 LDFLAGS_GC</a></h3>
<p>链接器生成二进制节 GC 选项，默认值为 <code>-Wl,--gc-sections</code> 。</p>
<p>设置后会和 <code>C_CXXFLAGS_GC</code> 通过 <code>$CXX</code> 作为编译器编译链接简单程序测试是否支持。若不支持，此变量和 <code>C_CXXFLAGS_GC</code> 都会被置空。</p>
<p><strong>已知限制</strong> <a href="http://sourceforge.net/p/msys2/discussion/general/thread/2d6adff2/?limit=25">Windows 上的工具链可能缺乏 <code>/dev/null</code> 的必要支持</a>，因此此项检查使用的输出路径指定为 <code>/tmp/null</code> 。</p>
<h3><a class="header" href="#变量-ldflags_strip" id="变量-ldflags_strip">变量 LDFLAGS_STRIP</a></h3>
<p>链接器剥离符号选项，默认值为 <code>-s</code> 。</p>
<h3><a class="header" href="#变量-c_cxxflags_arch" id="变量-c_cxxflags_arch">变量 C_CXXFLAGS_ARCH</a></h3>
<p>C 和 C++ 编译器共用的体系结构相关选项，默认值为空。</p>
<p>不限制具体形式，使用 G++ 时可以是 <code>-march=native</code> 。</p>
<h3><a class="header" href="#变量-c_cxxflags_pic" id="变量-c_cxxflags_pic">变量 C_CXXFLAGS_PIC</a></h3>
<p>C 和 C++ 编译器共用的 PIC （ Position Independent Code ，位置无关代码）生成选项，默认值在 Win32 上为空，其它平台上为 <code>-fPIC</code> 。</p>
<p>用于保证生成的对象文件可被用于生成动态库。</p>
<h3><a class="header" href="#变量-c_cxxflags_common" id="变量-c_cxxflags_common">变量 C_CXXFLAGS_COMMON</a></h3>
<p>C 和 C++ 编译器共用的公共选项，默认值为 <code>-pipe $C_CXXFLAGS_GC $C_CXXFLAGS_ARCH -pedantic-errors</code> 。</p>
<h3><a class="header" href="#变量-c_cxxflags_opt_lv" id="变量-c_cxxflags_opt_lv">变量 C_CXXFLAGS_OPT_LV</a></h3>
<p>C 和 C++ 编译器优化等级选项，默认值为 <code>-O3</code> 。</p>
<h3><a class="header" href="#变量-c_cxxflags_warning" id="变量-c_cxxflags_warning">变量 C_CXXFLAGS_WARNING</a></h3>
<p>C 和 C++ 编译器共用的警告命令行选项，默认值包括以下列表中的内容：</p>
<ul>
<li><code>-Wall</code></li>
<li><code>-Wcast-align</code></li>
<li><code>-Wdeprecated</code></li>
<li><code>-Wdeprecated-declarations</code></li>
<li><code>-Wextra</code></li>
<li><code>-Wfloat-equal</code></li>
<li><code>-Wformat=2</code></li>
<li><code>-Winvalid-pch</code></li>
<li><code>-Wmissing-declarations</code></li>
<li><code>-Wmissing-include-dirs</code></li>
<li><code>-Wmultichar</code></li>
<li><code>-Wno-format-nonliteral</code></li>
<li><code>-Wredundant-decls</code></li>
<li><code>-Wshadow</code></li>
<li><code>-Wsign-conversion</code></li>
</ul>
<p>使用符合项目要求支持的 Clang++ 和 G++ 应支持这些选项。</p>
<h3><a class="header" href="#变量-c_cxxflags_impl_warning" id="变量-c_cxxflags_impl_warning">变量 C_CXXFLAGS_IMPL_WARNING</a></h3>
<p>和特定实现相关的 C 和 C++ 编译器共用的警告命令行选项，默认值包括若干特定实现的选项。</p>
<h3><a class="header" href="#变量-cxxflags_impl_warning" id="变量-cxxflags_impl_warning">变量 CXXFLAGS_IMPL_WARNING</a></h3>
<p>和特定实现相关的 C++ 编译器警告命令行选项，默认值包括若干特定实现的选项。</p>
<h3><a class="header" href="#变量-cxxflags_impl_common" id="变量-cxxflags_impl_common">变量 CXXFLAGS_IMPL_COMMON</a></h3>
<p>和特定实现相关的 C++ 编译器一般命令行选项，默认值包括若干特定实现的选项。</p>
<p>默认值指定线程参数：通过 <code>-dumpspecs</code> 的内容检查是否支持 <code>-mthreads</code> ，若失败则检查 <code>uname</code> 结果，并在 Linux 或 Darwin 系统上补充 <code>-pthread</code> 选项。</p>
<p>当前暂不支持判断其它环境。</p>
<h3><a class="header" href="#变量-cxxflags_impl_opt" id="变量-cxxflags_impl_opt">变量 CXXFLAGS_IMPL_OPT</a></h3>
<p>和特定工具相关的 C++ 编译器优化命令行选项，默认值包括若干特定实现的选项。</p>
<h3><a class="header" href="#变量-cflags_std" id="变量-cflags_std">变量 CFLAGS_STD</a></h3>
<p>指定 C 标准的编译器命令行选项，默认值为 <code>-std=c11</code> 。</p>
<h3><a class="header" href="#变量-cflags_warning" id="变量-cflags_warning">变量 CFLAGS_WARNING</a></h3>
<p>C 编译器警告命令行选项，默认值为 <code>$C_CXXFLAGS_WARNING $C_CXXFLAGS_IMPL_WARNING</code> 。</p>
<h3><a class="header" href="#变量-cflags_common" id="变量-cflags_common">变量 CFLAGS_COMMON</a></h3>
<p>C 编译器一般命令行选项，默认值为 <code>$C_CXXFLAGS_COMMON $CFLAGS_STD $CFLAGS_WARNING</code> 。</p>
<h3><a class="header" href="#变量-cxxflags_std" id="变量-cxxflags_std">变量 CXXFLAGS_STD</a></h3>
<p>指定 C++ 标准的编译器命令行选项，默认值为 <code>-std=c++11</code> 。</p>
<h3><a class="header" href="#变量-cflags_warning-1" id="变量-cflags_warning-1">变量 CFLAGS_WARNING</a></h3>
<p>C 编译器警告命令行选项，默认值包含以下列表中的内容：</p>
<ul>
<li>变量 <code>CFLAGS_WARNING</code> 的内容</li>
<li><code>-Wctor-dtor-privacy</code></li>
<li><code>-Wnon-virtual-dtor</code></li>
<li><code>-Woverloaded-virtual</code></li>
<li><code>-Wsign-promo</code></li>
<li>变量 <code>CXXFLAGS_IMPL_WARNING</code> 的内容</li>
</ul>
<h3><a class="header" href="#变量-cxxflags_common" id="变量-cxxflags_common">变量 CXXFLAGS_COMMON</a></h3>
<p>C++ 编译器一般命令行选项，默认值为 <code>$CXXFLAGS_STD $C_CXXFLAGS_COMMON $CXXFLAGS_WARNING $CXXFLAGS_IMPL_COMMON</code> 。</p>
<h3><a class="header" href="#变量-cxxflags_opt_dbg" id="变量-cxxflags_opt_dbg">变量 CXXFLAGS_OPT_DBG</a></h3>
<p>C++ 编译器优化和调试相关的命令行选项，默认值包含以下列表中的内容：</p>
<ul>
<li>变量 <code>C_CXXFLAGS_OPT_LV</code> 的内容</li>
<li>变量 <code>CXXFLAGS_OPT_UseAssert</code> 没有被设置非空值时包含 <code>-NDEBUG</code></li>
<li>变量 <code>CXXFLAGS_IMPL_OPT</code> 的内容</li>
<li><code>-fomit-frame-pointer</code></li>
</ul>
<h3><a class="header" href="#变量-cflags" id="变量-cflags">变量 CFLAGS</a></h3>
<p>C 编译器使用的命令行选项，默认值为 <code>$C_CXXFLAGS_PIC $CFLAGS_COMMON $C_CXXFLAGS_COMMON_IMPL_ $CXXFLAGS_OPT_DBG</code> 。</p>
<p><strong>注意</strong> 当前和 C++ 编译器选项共用 <code>CXXFLAGS_OPT_DBG</code> 。</p>
<h3><a class="header" href="#变量-cxxflags" id="变量-cxxflags">变量 CXXFLAGS</a></h3>
<p>C++ 编译器使用的命令行选项，默认值为 <code>$C_CXXFLAGS_PIC $CXXFLAGS_COMMON $C_CXXFLAGS_COMMON_IMPL_ $CXXFLAGS_OPT_DBG</code> 。</p>
<h3><a class="header" href="#变量-ldflags_opt_dbg" id="变量-ldflags_opt_dbg">变量 LDFLAGS_OPT_DBG</a></h3>
<p>链接器优化和调试相关的命令行选项，默认值为 <code>$LDFLAGS_STRIP $LDFLAGS_IMPL_OPT $LDFLAGS_GC</code> 。</p>
<h3><a class="header" href="#变量-ldflags_dyn_base" id="变量-ldflags_dyn_base">变量 LDFLAGS_DYN_BASE</a></h3>
<p>指定动态库基础链接选项，默认值和平台相关：若为 Win32 环境则使用 <code>-shared -Wl,--dll</code> 否则为 <code>-shared</code> 。</p>
<h3><a class="header" href="#变量-ldflags_dyn_extra" id="变量-ldflags_dyn_extra">变量 LDFLAGS_DYN_EXTRA</a></h3>
<p>指定动态库附加链接选项，默认值等价于 <code>-Wl,--no-undefined,--dynamic-list-data,--dynamic-list-cpp-new,--dynamic-list-cpp-typeinfo</code> 。</p>
<h3><a class="header" href="#变量-ldflags_dyn" id="变量-ldflags_dyn">变量 LDFLAGS_DYN</a></h3>
<p>指定动态库链接选项，默认值为 <code>$LDFLAGS_DYN_EXTRA $LDFLAGS_DYN</code> 。</p>
<h3><a class="header" href="#变量-libs_rpath" id="变量-libs_rpath">变量 LIBS_RPATH</a></h3>
<p>用于指定在运行时 ELF 映像需要的动态库的路径的链接器选项。在 Win32 默认不设置，其它平台默认值为 <code>-Wl,-rpath,'\$ORIGIN:\$ORIGIN/../lib'</code> 。</p>
<h3><a class="header" href="#变量-libpfx" id="变量-libpfx">变量 LIBPFX</a></h3>
<p>库前缀。在 Win32 默认不设置，其它平台默认值为 <code>lib</code> 。</p>
<h3><a class="header" href="#变量-dsosfx" id="变量-dsosfx">变量 DSOSFX</a></h3>
<p>动态库文件名后缀。在 Win32 默认为 <code>.dll</code> ，其它平台默认值为 <code>.so</code> 。</p>
<h3><a class="header" href="#变量-exesfx" id="变量-exesfx">变量 EXESFX</a></h3>
<p>可执行文件名后缀。在 Win32 默认为 <code>.exe</code> ，其它平台默认不设置。</p>
<h3><a class="header" href="#变量-ldflags" id="变量-ldflags">变量 LDFLAGS</a></h3>
<p>链接器使用的命令行选项，默认值依次包含以下内容：</p>
<ul>
<li>变量 <code>C_CXXFLAGS_PIC</code> 的内容。</li>
<li>和变量 <code>CXXFLAGS_IMPL_COMMON</code> 中等价的线程命令行选项。</li>
<li>变量 <code>LDFLAGS_OPT_DBG</code> 的内容。</li>
<li>生成可执行程序时且要求按需调整链接器参数时，附加的值：
<ul>
<li>当需要生成 Win32 子系统程序时，附加 <code>-mwindows</code> 。</li>
</ul>
</li>
<li>动态可执行程序时，变量 <code>LIBS_RPATH</code> 的内容。</li>
<li>动态链接库时，变量 <code>LDFLAGS_DYN</code> 的内容。</li>
</ul>
<p>默认使用 <code>-Wl,</code> 传递链接器特定的命令行。</p>
<h2><a class="header" href="#toolsscriptsshbuild-common-toolchainsh" id="toolsscriptsshbuild-common-toolchainsh">Tools/Scripts/SHBuild-common-toolchain.sh</a></h2>
<p>被应用程序构建脚本包含的基础功能，提供默认的编译器和链接器等工具的名称。</p>
<p>默认使用 <code>gcc</code>/<code>g++</code>/<code>ar</code> 作为 C 编译器/ C++ 编译器和归档器，并使用 C++ 编译器命令作为链接器。</p>
<p><strong>这个脚本是公开的工具</strong>，被 <code>Tools/install-sysroot.sh</code> 部署到安装路径下的 <code>bin</code> 目录下。</p>
<h2><a class="header" href="#toolsscriptsshbuild-self-hostsh" id="toolsscriptsshbuild-self-hostsh">Tools/Scripts/SHBuild-self-host.sh</a></h2>
<p><a href="SHBuild.zh-CN.html">SHBuild</a> 自举测试用脚本。</p>
<p>使用 SHBuild 编译并静态链接构建 SHBuild 。和 stage 1 SHBuild 类似，直接使用 YSLib 源文件。</p>
<h2><a class="header" href="#toolsscriptsshbuild-self-host-dllsh" id="toolsscriptsshbuild-self-host-dllsh">Tools/Scripts/SHBuild-self-host-DLL.sh</a></h2>
<p><a href="SHBuild.zh-CN.html">SHBuild</a> 自举测试用脚本。</p>
<p>使用 SHBuild 编译并动态链接构建 SHBuild 。依赖 <code>/usr/lib</code> 中存在的 YFramework.dll 和 YBase.dll 。</p>
<h2><a class="header" href="#toolsscriptsshbuild-yslibtxt" id="toolsscriptsshbuild-yslibtxt">Tools/Scripts/SHBuild-YSLib*.txt</a></h2>
<p>构建 YSLib 用的 NPLA1 脚本，包含以下文件：</p>
<ul>
<li>Tools/Scripts/SHBuild-YSLib-common.txt ：被 <code>Tools/Scripts/SHBuild-YSLib-build.txt</code> 加载的 NPLA1 脚本。</li>
<li>Tools/Scripts/SHBuild-YSLib-build.txt ：使用 SHBuild 构建 debug 或 release 配置的 YBase 和 YFramework 库的 NPLA1 脚本，被 <code>Tools/install-sysroot.sh</code> 调用，其中 SHBuild 默认为 stage 1 SHBuild 。</li>
<li>Tools/Scripts/SHBuild-YSLib.sh ：当前被保留。</li>
</ul>
<p>调用方式详见 <a href="SHBuild.zh-CN.html">stage 1 SHBuild 中关于 NPL 支持的说明</a>。</p>
<p>可通过外部环境变量配置脚本行为。</p>
<h3><a class="header" href="#toolsscriptsshbuild-yslib-commontxt" id="toolsscriptsshbuild-yslib-commontxt">Tools/Scripts/SHBuild-YSLib-common.txt</a></h3>
<p><code>Tools/Scripts/SHBuild-YSLib-common.txt</code> 包含一些公共的库，包括支持 <code>Tools/Scripts/SHBuild-common-options.sh</code> 和 <code>Tools/Scripts/SHBuild-common-toolchain.sh</code> 的选项以环境变量的方式配置，但 C 编译器相关的选项除外（不使用而被忽略）。</p>
<p>这个脚本被 <code>Tools/Scripts/SHBuild-YSLib-build.txt</code> 加载，并被 <code>Tools/install-sysroot.sh</code> 间接调用。</p>
<p>可以在外部调用这个脚本的命令行设置变量以覆盖直接指定需要的选项，如：</p>
<pre><code>CXX=clang++ CXXFLAGS='-std=c++11 -O2' Tools/install-sysroot.sh
</code></pre>
<p><strong>使用预编译头选项和缺陷同 <code>Tools/Scripts/SHBuild-build.sh</code> 。其中的特性未指定使用 shell 实现，和后者可能存在 shell 环境中可见的差异。</strong></p>
<h3><a class="header" href="#toolsscriptsshbuild-yslib-buildtxt" id="toolsscriptsshbuild-yslib-buildtxt">Tools/Scripts/SHBuild-YSLib-build.txt</a></h3>
<p>这个脚本当前包括和安装相关的流程，实现 <code>Tools/install-sysroot.sh</code> 在 stage 1 SHBuild 构建后的主要逻辑。</p>
<p>脚本支持 <code>SHBuild_</code> 为前缀的环境变量指定构建和部署目标：</p>
<ul>
<li><code>SHBuild_UseDebug</code> 非空时同时构建和安装 debug 配置的库，否则只构建和安装 release 配置的库。</li>
<li><code>SHBuild_NoStatic</code> 非空时跳过静态库构建。</li>
<li><code>SHBuild_NoDynamic</code> 非空时跳过动态库构建。</li>
<li><code>SHBuild_No3rd</code> 非空时跳过第三方库安装。</li>
<li><code>SHBuild_NoDev</code> 非空时跳过可选的开发工具构建和安装。</li>
<li><code>SHBuild_Rebuild_S1</code> 非空时跳过文件存在性检查，总是重新构建 stage 1 SHBuild 。</li>
<li><code>SHBuild_NoDev</code> 非空时跳过 stage 2 SHBuild 后的开发工具构建和安装。</li>
</ul>
<p>以下配置行为的环境变量（其中 <code>SS</code> 表示 SHBuild Settings ）被支持：</p>
<ul>
<li><code>SS_DebugEnv</code> 值非空时启用脚本执行时系统环境相关的调试输出，当前包括：
<ul>
<li>对环境变量修改时输出修改的变量名和对应的值。</li>
</ul>
</li>
<li><code>SS_Verbose</code> 值非空时启用详细消息输出，当前包括：
<ul>
<li>在 <code>LDFLAGS</code> 变量中附加 <code>-mwindows</code> 时提示。</li>
</ul>
</li>
</ul>
<p><code>Tools/Scripts/SHBuild-YSLib-build.txt</code> 也可能使用其它变量用于传递参数给被调用的命令，包括一些 <code>SHBuild</code> 预期的变量；后者作为公开接口，但<strong>其具体含义和使用不保证在不同版本间稳定</strong>。</p>
<p>在 stage 1 构建时，接受以下环境变量：</p>
<ul>
<li><code>INCLUDES_freetype</code> 指定覆盖包含路径的编译器命令行选项，默认值以 <code>-I</code> 起始，使用版本库目录下的 <code>3rdparty/freetype/include</code> 目录带有适当引号的完整路径。</li>
</ul>
<p>在 stage 2 构建时接受以下外部环境变量（部分被 SHBuild 直接以环境变量的方式接受）：</p>
<ul>
<li><code>INCLUDES</code> 包含路径，和非 SHBuild 中的 <code>Makefile</code> 惯用法含义类似。</li>
<li><code>LDFLAGS</code> 链接命令行选项。</li>
<li><code>LIBS</code> 作为命令行选项的链接时使用的库路径。</li>
<li><code>LIBS_RPATH</code> 非 Windows 平台使用的 <code>rpath</code> 路径。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../Tools/ProjectGenerator.zh-CN.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../Tutorial.zh-CN.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../Tools/ProjectGenerator.zh-CN.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../Tutorial.zh-CN.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
